<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2311/2311545.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ê≤πËÄóË®òÈåÑ‰ª£">
    
    <title>Ê≤πËÄó App</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-text: #000000;
            --ios-blue: #007AFF;
            --ios-sep: #C6C6C8;
        }

        /* ÈªëÁôΩ‰ªãÈù¢Ëá™ÂãïÂàáÊèõ */
        @media (prefers-color-scheme: dark) {
            :root {
                --ios-bg: #000000;
                --ios-card: #1C1C1E;
                --ios-text: #FFFFFF;
                --ios-blue: #0A84FF;
                --ios-sep: #38383A;
            }
        }

        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background-color: var(--ios-bg); 
            margin: 0; padding: 20px; color: var(--ios-text);
            padding-top: env(safe-area-inset-top, 20px);
        }

        h1 { font-size: 34px; font-weight: 800; margin: 20px 0; letter-spacing: -1px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card { 
            background: var(--ios-card); padding: 15px; border-radius: 12px; text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .stat-card strong { display: block; font-size: 26px; color: var(--ios-blue); }
        .stat-card span { font-size: 12px; color: #8E8E93; font-weight: 600; }

        .segmented {
            background: #7676801f; border-radius: 10px; padding: 2px;
            display: flex; margin-bottom: 25px;
        }
        .segment {
            flex: 1; padding: 8px 0; text-align: center; font-size: 13px; font-weight: 600;
            cursor: pointer; border-radius: 8px; color: var(--ios-text);
        }
        .segment.active { background: var(--ios-card); box-shadow: 0 3px 8px rgba(0,0,0,0.12); }

        .ios-list { background: var(--ios-card); border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .ios-item { display: flex; align-items: center; padding: 12px 16px; border-bottom: 0.5px solid var(--ios-sep); }
        .ios-item:last-child { border-bottom: none; }
        .ios-item label { flex: 1; font-size: 17px; }
        .ios-item input { border: none; background: none; font-size: 17px; text-align: right; width: 60%; color: var(--ios-blue); outline: none; }

        .btn { 
            width: 100%; padding: 16px; border-radius: 12px; background: var(--ios-blue); 
            color: white; border: none; font-size: 17px; font-weight: 600; cursor: pointer;
        }
        .btn:active { opacity: 0.7; }

        .record-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 0.5px solid var(--ios-sep); }
        .record-val { font-size: 20px; font-weight: 700; color: var(--ios-blue); }

        .sec { display: none; }
        .sec.active { display: block; }
    </style>
</head>
<body>

    <h1>Á¥ÄÈåÑ</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <strong id="avgVal">0.00</strong>
            <span>Âπ≥Âùá km/L</span>
        </div>
        <div class="stat-card">
            <strong id="countVal">0</strong>
            <span>Á∏ΩÁ≠ÜÊï∏</span>
        </div>
    </div>

    <div class="segmented">
        <div class="segment active" onclick="tab(0)">Êñ∞Â¢û</div>
        <div class="segment" onclick="tab(1)">ÂúñË°®</div>
        <div class="segment" onclick="tab(2)">ÊòéÁ¥∞</div>
    </div>

    <div id="s0" class="sec active">
        <div class="ios-list">
            <input type="hidden" id="editIdx" value="-1">
            <div class="ios-item"><label>Êó•Êúü</label><input type="date" id="date"></div>
            <div class="ios-item"><label>ÂÖ¨Âçá (L)</label><input type="number" id="liters" placeholder="0.00"></div>
            <div class="ios-item"><label>ÈáåÁ®ã (km)</label><input type="number" id="distance" placeholder="0.0"></div>
        </div>
        <button class="btn" onclick="save()">ÂÑ≤Â≠òÊï∏Êìö</button>
    </div>

    <div id="s1" class="sec">
        <div class="stat-card"><canvas id="chart"></canvas></div>
    </div>

    <div id="s2" class="sec">
        <div class="ios-list" id="list" style="padding: 0 16px;"></div>
        <button onclick="exportXLS()" style="color:var(--ios-blue); background:none; border:none; width:100%; padding:20px; font-size:16px;">üì• Â∞éÂá∫ Excel</button>
        <button onclick="clearAll()" style="color:#FF3B30; background:none; border:none; width:100%; font-size:12px;">ÈáçÁΩÆ App</button>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('fuelRecords')) || [];
        let chart;

        window.onload = () => {
            document.getElementById('date').valueAsDate = new Date();
            initChart();
            render();
        };

        function tab(i) {
            document.querySelectorAll('.segment').forEach((s, x) => s.classList.toggle('active', x===i));
            document.querySelectorAll('.sec').forEach((s, x) => s.classList.toggle('active', x===i));
            if(i===1) updateChart();
        }

        function save() {
            const d = document.getElementById('date').value;
            const l = parseFloat(document.getElementById('liters').value);
            const km = parseFloat(document.getElementById('distance').value);
            const idx = parseInt(document.getElementById('editIdx').value);
            if(!d || !l || !km) return alert("Ë´ãÂ°´ÂØ´ÂÆåÊï¥");
            const entry = { d, l, km, cons: Number((km/l).toFixed(2)) };
            if(idx === -1) records.push(entry);
            else records[idx] = entry;
            records.sort((a,b) => new Date(a.d) - new Date(b.d));
            localStorage.setItem('fuelRecords', JSON.stringify(records));
            document.getElementById('editIdx').value="-1";
            document.getElementById('liters').value='';
            document.getElementById('distance').value='';
            render(); tab(2);
        }

        function render() {
            const valid = records.filter(r => !isNaN(r.cons));
            document.getElementById('avgVal').innerText = valid.length ? (valid.reduce((s,r) => s+r.cons, 0)/valid.length).toFixed(2) : "0.00";
            document.getElementById('countVal').innerText = records.length;
            const container = document.getElementById('list');
            container.innerHTML = '';
            [...records].reverse().forEach(r => {
                const i = records.indexOf(r);
                container.innerHTML += `<div class="record-row">
                    <div><b>${r.d}</b><br><small style="color:#8E8E93">${r.l}L / ${r.km}km</small></div>
                    <div style="text-align:right"><span class="record-val">${r.cons}</span><br>
                    <small style="color:var(--ios-blue)" onclick="editRecord(${i})">Êîπ</small>
                    <small style="color:#FF3B30;margin-left:10px" onclick="del(${i})">Âà™</small></div>
                </div>`;
            });
        }

        function editRecord(i) {
            const r = records[i];
            document.getElementById('date').value = r.d;
            document.getElementById('liters').value = r.l;
            document.getElementById('distance').value = r.km;
            document.getElementById('editIdx').value = i;
            tab(0);
        }

        function del(i) { if(confirm("Âà™Èô§Ôºü")) { records.splice(i,1); localStorage.setItem('fuelRecords', JSON.stringify(records)); render(); } }
        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            chart = new Chart(ctx, { type:'line', data:{labels:[], datasets:[{data:[], borderColor:'#007AFF', tension:0.4}]}, options:{plugins:{legend:{display:false}}}});
        }
        function updateChart() {
            chart.data.labels = records.map(r => r.d);
            chart.data.datasets[0].data = records.map(r => r.cons);
            chart.update();
        }
        function clearAll() { if(confirm("ÂÖ®ÈÉ®Âà™Èô§Ôºü")) { localStorage.clear(); records=[]; render(); } }
        function exportXLS() { const ws = XLSX.utils.json_to_sheet(records); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Fuel"); XLSX.writeFile(wb, "Fuel_Log.xlsx"); }
    </script>
</body>
</html>
