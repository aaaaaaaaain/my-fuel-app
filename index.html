<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ²¹è€—è¨˜éŒ„</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-text: #000000;
            --ios-secondary: #8E8E93;
            --ios-sep: #C6C6C8;
        }

        /* è‡ªå‹•æ„Ÿæ‡‰æ·±è‰²æ¨¡å¼ */
        @media (prefers-color-scheme: dark) {
            :root {
                --ios-bg: #000000;
                --ios-card: #1C1C1E;
                --ios-text: #FFFFFF;
                --ios-secondary: #8E8E93;
                --ios-sep: #38383A;
            }
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            background-color: var(--ios-bg); 
            margin: 0; padding: 20px; color: var(--ios-text);
            padding-top: 70px;
            transition: background 0.3s, color 0.3s;
        }

        /* å°è¦½åˆ—ä¿®æ­£ï¼šé¿å…æ“‹ä½å…§å®¹ */
        .header { 
            position: fixed; top: 0; left: 0; right: 0; 
            padding: 10px 20px; 
            background: var(--ios-bg);
            opacity: 0.95;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { margin: 0; font-size: 28px; font-weight: 800; }

        /* çµ±è¨ˆæ•¸å€¼å€ï¼šä¿®æ­£é‡ç–Šå•é¡Œ */
        .card { 
            background: var(--ios-card); 
            border-radius: 14px; padding: 18px; margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .stats { display: flex; justify-content: space-around; text-align: center; }
        .stat-item strong { display: block; font-size: 26px; font-weight: 700; color: var(--ios-blue); margin-bottom: 4px; }
        .stat-item span { font-size: 12px; color: var(--ios-secondary); font-weight: 500; }

        /* åˆ†æ®µæ§åˆ¶ */
        .segmented-control {
            background: #7676801f; border-radius: 10px; padding: 2px;
            display: flex; margin-bottom: 20px;
        }
        .segment {
            flex: 1; padding: 7px 0; text-align: center; font-size: 13px; font-weight: 600;
            cursor: pointer; border-radius: 8px; transition: 0.2s; color: var(--ios-text);
        }
        .segment.active { background: var(--ios-card); box-shadow: 0 3px 8px rgba(0,0,0,0.15); }

        /* æ¸…å–®æ¨£å¼ */
        .list-group { background: var(--ios-card); border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .list-item { 
            display: flex; align-items: center; padding: 14px 16px; 
            border-bottom: 0.5px solid var(--ios-sep); 
        }
        .list-item:last-child { border-bottom: none; }
        .list-item label { flex: 1; font-size: 17px; display: flex; align-items: center; gap: 10px; }
        .list-item input { 
            border: none; background: none; font-size: 17px; text-align: right; 
            width: 50%; color: var(--ios-blue); outline: none; 
        }

        .action-btn { 
            width: 100%; padding: 16px; border-radius: 14px; 
            background: var(--ios-blue); color: white; font-size: 17px; font-weight: 600;
            border: none; cursor: pointer;
        }
        .action-btn:active { opacity: 0.7; }

        /* æ­·å²è¨˜éŒ„åˆ— */
        .record-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 0.5px solid var(--ios-sep); 
        }
        .record-row:last-child { border-bottom: none; }
        .record-info { display: flex; flex-direction: column; }
        .record-date { font-size: 16px; font-weight: 600; }
        .record-sub { font-size: 12px; color: var(--ios-secondary); }
        .record-val { font-size: 20px; font-weight: 700; color: var(--ios-blue); }

        /* å…§å®¹éš±è— */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <h1>è¨˜éŒ„</h1>
        <i data-lucide="settings" style="width:20px; color:var(--ios-blue)" onclick="clearAll()"></i>
    </div>

    <div class="card stats">
        <div class="stat-item">
            <strong id="avgVal">0.00</strong>
            <span>å¹³å‡ km/L</span>
        </div>
        <div class="stat-item">
            <strong id="countVal">0</strong>
            <span>è¨˜éŒ„ç­†æ•¸</span>
        </div>
    </div>

    <div class="segmented-control">
        <div class="segment active" onclick="switchTab(0)">æ–°å¢æ•¸æ“š</div>
        <div class="segment" onclick="switchTab(1)">è¶¨å‹¢åœ–</div>
        <div class="segment" onclick="switchTab(2)">æ˜ç´°è¡¨</div>
    </div>

    <div id="sec-0" class="section active">
        <div class="list-group">
            <input type="hidden" id="editIndex" value="-1">
            <div class="list-item">
                <label><i data-lucide="calendar" style="width:18px;color:#FF2D55"></i>æ—¥æœŸ</label>
                <input type="date" id="date">
            </div>
            <div class="list-item">
                <label><i data-lucide="fuel" style="width:18px;color:#FF9500"></i>å…¬å‡ (L)</label>
                <input type="number" id="liters" placeholder="0.00">
            </div>
            <div class="list-item">
                <label><i data-lucide="milestone" style="width:18px;color:#34C759"></i>é‡Œç¨‹ (km)</label>
                <input type="number" id="distance" placeholder="0.0">
            </div>
        </div>
        <button id="saveBtn" class="action-btn" onclick="saveRecord()">å„²å­˜æ•¸æ“š</button>
        <button id="cancelBtn" class="action-btn" style="display:none; background:#8E8E93; margin-top:10px;" onclick="resetForm()">å–æ¶ˆç·¨è¼¯</button>
    </div>

    <div id="sec-1" class="section">
        <div class="card">
            <canvas id="fuelChart"></canvas>
        </div>
    </div>

    <div id="sec-2" class="section">
        <div class="card" style="padding-bottom:5px">
            <div id="recordBody"></div>
        </div>
        <button onclick="exportToExcel()" style="color:var(--ios-blue); background:none; border:none; width:100%; font-size:16px; margin: 15px 0;">ğŸ“¥ å°å‡º Excel å ±è¡¨</button>
    </div>

    <script>
        lucide.createIcons();
        let records = JSON.parse(localStorage.getItem('fuelRecords')) || [];
        let fuelChart;

        window.onload = () => {
            document.getElementById('date').valueAsDate = new Date();
            initChart();
            renderAll();
        };

        function switchTab(idx) {
            document.querySelectorAll('.segment').forEach((s, i) => s.classList.toggle('active', i === idx));
            document.querySelectorAll('.section').forEach((s, i) => s.classList.toggle('active', i === idx));
            if(idx === 1) updateChart();
        }

        function saveRecord() {
            const date = document.getElementById('date').value;
            const liters = parseFloat(document.getElementById('liters').value);
            const distance = parseFloat(document.getElementById('distance').value);
            const editIndex = parseInt(document.getElementById('editIndex').value);

            if (!date || !liters || !distance) return alert("è«‹å¡«å…¥å®Œæ•´æ•¸å€¼");

            const consumption = Number((distance / liters).toFixed(2));
            const entry = { date, liters, distance, consumption };

            if (editIndex === -1) records.push(entry);
            else records[editIndex] = entry;

            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('fuelRecords', JSON.stringify(records));
            resetForm();
            renderAll();
            switchTab(2);
        }

        function renderAll() {
            const body = document.getElementById('recordBody');
            body.innerHTML = '';
            
            // ä¿®æ­£è¨ˆç®—å¹³å‡æ²¹è€—çš„é‚è¼¯ï¼Œé¿å…å‡ºç¾ NaN
            const valid = records.filter(r => !isNaN(r.consumption));
            const total = valid.reduce((s, r) => s + r.consumption, 0);
            const avg = valid.length ? (total / valid.length).toFixed(2) : "0.00";
            
            document.getElementById('avgVal').innerText = avg;
            document.getElementById('countVal').innerText = records.length;

            [...records].reverse().forEach(r => {
                const idx = records.indexOf(r);
                body.innerHTML += `
                    <div class="record-row">
                        <div class="record-info">
                            <span class="record-date">${r.date}</span>
                            <span class="record-sub">${r.liters}L / ${r.distance}km</span>
                        </div>
                        <div style="text-align:right">
                            <span class="record-val">${r.consumption}</span><br>
                            <small style="color:var(--ios-blue)" onclick="editRecord(${idx})">æ”¹</small>
                            <small style="color:#FF3B30;margin-left:10px" onclick="deleteRecord(${idx})">åˆª</small>
                        </div>
                    </div>
                `;
            });
            updateChart();
        }

        function editRecord(idx) {
            const r = records[idx];
            document.getElementById('date').value = r.date;
            document.getElementById('liters').value = r.liters;
            document.getElementById('distance').value = r.distance;
            document.getElementById('editIndex').value = idx;
            document.getElementById('saveBtn').innerText = "ç¢ºèªä¿®æ”¹";
            document.getElementById('cancelBtn').style.display = "block";
            switchTab(0);
        }

        function deleteRecord(idx) {
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { records.splice(idx,1); localStorage.setItem('fuelRecords', JSON.stringify(records)); renderAll(); }
        }

        function resetForm() {
            document.getElementById('editIndex').value="-1";
            document.getElementById('liters').value='';
            document.getElementById('distance').value='';
            document.getElementById('saveBtn').innerText="å„²å­˜æ•¸æ“š";
            document.getElementById('cancelBtn').style.display="none";
        }

        function initChart() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const ctx = document.getElementById('fuelChart').getContext('2d');
            fuelChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'km/L', data: [], borderColor: '#007AFF', tension: 0.4, fill: false }] },
                options: { 
                    scales: { y: { grid: { color: isDark ? '#38383A' : '#E5E5E7' } } },
                    plugins: { legend: { display: false } } 
                }
            });
        }

        function updateChart() {
            fuelChart.data.labels = records.map(r => r.date);
            fuelChart.data.datasets[0].data = records.map(r => r.consumption);
            fuelChart.update();
        }

        function clearAll() {
            if(confirm("é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); records=[]; renderAll(); }
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(records);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "OilRecord");
            XLSX.writeFile(wb, "Fuel_iOS_Log.xlsx");
        }
    </script>
</body>
</html>